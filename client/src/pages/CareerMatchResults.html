<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Career Matches - Kaizen Job Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            500: '#64748b',
                            600: '#475569',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .loading-text {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s ease-out forwards;
        }
        
        .loading-text:nth-child(1) { animation-delay: 0s; }
        .loading-text:nth-child(2) { animation-delay: 2s; }
        .loading-text:nth-child(3) { animation-delay: 4s; }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="min-h-screen flex flex-col items-center justify-center">
            <div class="text-center space-y-8">
                <!-- Logo/Brand -->
                <div class="mb-8">
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">Kaizen Job Portal</h1>
                    <p class="text-gray-600">Your Career Matches</p>
                </div>
                
                <!-- Spinner -->
                <div class="flex justify-center">
                    <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full spinner"></div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-64 bg-gray-200 rounded-full h-2 mx-auto">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <!-- Loading Messages -->
                <div class="space-y-4">
                    <p class="loading-text text-lg text-gray-700 font-medium">Taking you a step closer towards a better future...</p>
                    <p class="loading-text text-lg text-gray-700 font-medium">Analyzing your unique skills and preferences...</p>
                    <p class="loading-text text-lg text-gray-700 font-medium">Finding the perfect career matches for you...</p>
                </div>
            </div>
        </div>

        <!-- Results State -->
        <div id="resultsState" class="hidden">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Your Career Matches</h1>
                <p class="text-gray-600">Based on your assessment, here are the roles that best fit your profile</p>
            </div>

            <!-- Results Grid -->
            <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Cards will be dynamically inserted here -->
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="retakeAssessment()" class="btnOutline">
                    Retake Assessment
                </button>
                <button onclick="goToHome()" class="btnSecondary">
                    Go to Home
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';
        const apiKey = 'YOUR_GEMINI_API_KEY'; // Will be populated by environment

        // Mock assessment data (will be replaced with real data from URL params)
        const mockAssessmentData = {
            basicDetails: {
                name: "John Doe",
                email: "john@example.com",
                phone: "1234567890",
                degree: "BTech",
                institution: "Example University"
            },
            coreValues: ["Innovation", "Collaboration", "Continuous Learning", "Problem-Solving", "Integrity"],
            workPreferences: {
                independence: 75,
                routine: 30,
                pace: 80,
                focus: 60,
                approach: 70
            },
            workStyle: {
                q1: 4, q2: 3, q3: 4, q4: 2, q5: 5,
                q6: 3, q7: 4, q8: 3, q9: 4, q10: 2
            }
        };

        // Get real job data from the portal
        let realJobData = [];

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Get assessment data from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const assessmentDataParam = urlParams.get('assessmentData');
            
            let assessmentData = mockAssessmentData;
            if (assessmentDataParam) {
                try {
                    assessmentData = JSON.parse(decodeURIComponent(assessmentDataParam));
                } catch (error) {
                    console.error('Error parsing assessment data:', error);
                }
            }

            // Fetch real job data from the portal
            await fetchRealJobData();
            
            // Simulate loading progress
            simulateLoadingProgress();
            
            // Wait for loading animation
            await new Promise(resolve => setTimeout(resolve, 6000));
            
            // Call Gemini API
            try {
                const careerMatches = await getCareerMatches(assessmentData);
                displayResults(careerMatches, assessmentData);
            } catch (error) {
                console.error('Error getting career matches:', error);
                // Show error message
                document.getElementById('loadingState').innerHTML = `
                    <div class="text-center space-y-4">
                        <h2 class="text-2xl font-bold text-red-600">Error Loading Results</h2>
                        <p class="text-gray-600">Unable to generate career matches at this time.</p>
                        <button onclick="window.location.reload()" class="btnPrimary">Try Again</button>
                    </div>
                `;
            }
        }

        async function fetchRealJobData() {
            try {
                // Fetch jobs from the portal API
                const response = await fetch('/api/jobs');
                if (response.ok) {
                    const data = await response.json();
                    realJobData = data.jobs || [];
                }
            } catch (error) {
                console.error('Error fetching real job data:', error);
                realJobData = [];
            }
        }

        function simulateLoadingProgress() {
            const progressBar = document.getElementById('progressBar');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                progressBar.style.width = progress + '%';
            }, 200);
        }

        async function getCareerMatches(assessmentData) {
            const prompt = createPrompt(assessmentData);
            
            const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const responseText = data.candidates[0].content.parts[0].text;
            
            // Extract JSON from the response
            const jsonMatch = responseText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('Invalid response format');
            }
        }

        function createPrompt(assessmentData) {
            return `You are a career counselor analyzing assessment data. Based on the following assessment data, suggest 3-6 job roles that would be a perfect match for this candidate.

Assessment Data:
- Basic Details: ${JSON.stringify(assessmentData.basicDetails)}
- Core Values: ${assessmentData.coreValues.join(', ')}
- Work Preferences: ${JSON.stringify(assessmentData.workPreferences)}
- Work Style: ${JSON.stringify(assessmentData.workStyle)}

Please analyze this data and return a JSON object with the following schema:
{
  "careerMatches": [
    {
      "jobTitle": "string (e.g., 'Software Developer')",
      "jobDescription": "string (one-line summary)",
      "relevantLogo": "string (single Unicode emoji)",
      "whyYouMatch": ["string", "string", "string"] (3 concise points),
      "fitmentScore": number (0-100, based on how well the role matches the assessment)
    }
  ]
}

Focus on roles that align with:
1. The selected core values
2. Work preferences (independence vs collaboration, pace, etc.)
3. Work style assessment answers
4. Educational background

Calculate fitment score based on:
- Core values alignment (20 points)
- Work preferences match (30 points)
- Work style compatibility (30 points)
- Educational background relevance (20 points)

Return only valid JSON, no additional text.`;
        }

        function displayResults(careerMatches, assessmentData) {
            // Hide loading state
            document.getElementById('loadingState').classList.add('hidden');
            
            // Show results state
            document.getElementById('resultsState').classList.remove('hidden');
            
            // Filter matches to only show roles that exist in real job data
            const filteredMatches = filterMatchesWithRealJobs(careerMatches.careerMatches);
            
            if (filteredMatches.length === 0) {
                document.getElementById('resultsGrid').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üîç</div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">No Matching Jobs Found</h3>
                        <p class="text-gray-600">We couldn't find any current job openings that match your profile.</p>
                        <p class="text-gray-500 text-sm mt-2">Try checking back later or retake the assessment.</p>
                    </div>
                `;
                return;
            }
            
            // Render career match cards
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';
            
            filteredMatches.forEach((match, index) => {
                const card = createCareerCard(match, index);
                resultsGrid.appendChild(card);
            });
        }

        function filterMatchesWithRealJobs(matches) {
            // Get unique job titles from real job data
            const realJobTitles = [...new Set(realJobData.map(job => job.title))];
            
            // Filter matches to only include roles that exist in real job data
            return matches.filter(match => {
                return realJobTitles.some(realTitle => 
                    realTitle.toLowerCase().includes(match.jobTitle.toLowerCase()) ||
                    match.jobTitle.toLowerCase().includes(realTitle.toLowerCase())
                );
            });
        }

        function createCareerCard(match, index) {
            // Find matching jobs in real data
            const matchingJobs = realJobData.filter(job => 
                job.title.toLowerCase().includes(match.jobTitle.toLowerCase()) ||
                match.jobTitle.toLowerCase().includes(job.title.toLowerCase())
            );
            
            const availableJobs = matchingJobs.length;
            const fitmentScore = match.fitmentScore || 85; // Default if not provided
            
            // Determine score color
            let scoreColor, scoreBgColor;
            if (fitmentScore >= 90) {
                scoreColor = 'text-green-600';
                scoreBgColor = 'bg-green-100';
            } else if (fitmentScore >= 80) {
                scoreColor = 'text-purple-600';
                scoreBgColor = 'bg-purple-100';
            } else {
                scoreColor = 'text-red-600';
                scoreBgColor = 'bg-red-100';
            }
            
            const card = document.createElement('div');
            card.className = `card-hover bg-white rounded-lg shadow-md p-4 cursor-pointer fade-in`;
            card.style.animationDelay = `${index * 0.2}s`;
            
            card.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl mb-3">${match.relevantLogo}</div>
                    
                    <!-- Fitment Score -->
                    <div class="mb-3">
                        <div class="inline-flex items-center px-3 py-1 rounded-full ${scoreBgColor}">
                            <span class="text-sm font-bold ${scoreColor}">${fitmentScore}% Match</span>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 mb-2">${match.jobTitle}</h3>
                    <p class="text-sm text-gray-600 mb-3">${match.jobDescription}</p>
                    
                    <div class="text-left mb-3">
                        <h4 class="font-semibold text-gray-900 mb-2 text-sm">Why You Match:</h4>
                        <ul class="space-y-1">
                            ${match.whyYouMatch.map(point => `
                                <li class="text-xs text-gray-600 flex items-start">
                                    <span class="text-green-500 mr-2 mt-0.5">‚úì</span>
                                    <span>${point}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="border-t pt-3">
                        <p class="text-xs text-gray-500">
                            ${availableJobs > 0 ? 
                                `<span class="text-green-600 font-semibold">${availableJobs} role${availableJobs > 1 ? 's' : ''} available</span> on Kaizen Job Portal` : 
                                'No current openings'
                            }
                        </p>
                    </div>
                </div>
            `;
            
            // Add click handler
            card.addEventListener('click', () => {
                handleCardClick(match.jobTitle, matchingJobs);
            });
            
            return card;
        }

        function handleCardClick(jobTitle, matchingJobs) {
            if (matchingJobs.length === 0) {
                // No matching jobs, show message
                alert('No current openings for this role. Please check back later.');
                return;
            }
            
            if (matchingJobs.length === 1) {
                // Single job, redirect directly to job detail
                window.location.href = `/job/${matchingJobs[0].jobId}`;
            } else {
                // Multiple jobs, redirect to job listings with filter
                const encodedTitle = encodeURIComponent(jobTitle);
                window.location.href = `/jobs?role=${encodedTitle}`;
            }
        }

        function retakeAssessment() {
            window.location.href = '/assessment';
        }

        function goToHome() {
            window.location.href = '/';
        }

        // Utility functions for styling
        function btnPrimary() {
            return 'bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-lg hover:shadow-xl hover:from-blue-700 hover:to-purple-700 transform hover:-translate-y-0.5';
        }

        function btnSecondary() {
            return 'bg-gradient-to-r from-gray-600 to-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 shadow-lg hover:shadow-xl hover:from-gray-700 hover:to-gray-800';
        }

        function btnOutline() {
            return 'border-2 border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50';
        }
    </script>
</body>
</html> 